<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Trắc nghiệm Triết học Mác-Lênin - PTIT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .topic-card { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; }
        .topic-card:hover { transform: translateY(-2px); border-color: #3b82f6; }
        .topic-selected { border-color: #2563eb !important; background-color: #eff6ff !important; }
        .option-card:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .option-selected { border-color: #2563eb !important; background-color: #dbeafe !important; font-weight: 600; }
        .correct-answer { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .wrong-answer { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        #loading-overlay { backdrop-filter: blur(8px); }
    </style>
</head>
<body class="text-slate-800">

    <!-- Màn hình chờ tải dữ liệu & Nút chọn file thủ công -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div id="loading-spinner" class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="text-slate-600 font-medium mb-6">Đang tìm file questions.json...</p>
        
        <!-- Nút chọn file thủ công (Chỉ hiện khi fetch lỗi) -->
        <div id="manual-upload" class="hidden text-center p-6 bg-white rounded-2xl shadow-xl border border-slate-200 max-w-sm mx-4">
            <p class="text-sm text-slate-500 mb-4">Không thể tự động nạp file (do bảo mật trình duyệt hoặc thiếu file). Hãy chọn file từ máy bạn:</p>
            <input type="file" id="file-input" accept=".json" class="hidden" onchange="quizApp.handleManualFile(event)">
            <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-all">
                Chọn file questions.json
            </button>
        </div>
    </div>

    <div id="app" class="max-w-5xl mx-auto px-4 py-8">
        <!-- MÀN HÌNH BẮT ĐẦU & CHỌN CHỦ ĐỀ -->
        <div id="start-screen" class="space-y-6">
            <div class="bg-white rounded-3xl shadow-sm p-8 text-center border border-slate-200">
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Ngân hàng Câu hỏi Triết học</h1>
                <p class="text-slate-500 text-lg mb-6">Học phần: BAS1150 - Triết học Mác-Lênin</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-left">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="block text-xs text-slate-400 uppercase font-bold mb-1">Thời gian làm bài</span>
                        <select id="timer-select" class="w-full bg-transparent text-lg font-bold text-blue-600 focus:outline-none">
                            <option value="15">15 Phút</option>
                            <option value="30" selected>30 Phút</option>
                            <option value="60">60 Phút</option>
                        </select>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="block text-xs text-slate-400 uppercase font-bold mb-1">Tổng câu hỏi</span>
                        <span id="stat-total-questions" class="text-lg font-bold text-blue-600">--</span>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="block text-xs text-slate-400 uppercase font-bold mb-1">Chủ đề đang chọn</span>
                        <span id="stat-selected-topic" class="text-lg font-bold text-blue-600">Tất cả</span>
                    </div>
                </div>

                <h3 class="text-left font-bold text-slate-700 mb-4 px-2">Chọn chủ đề ôn tập:</h3>
                <div id="topic-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-10"></div>

                <button id="start-btn" onclick="quizApp.startQuiz()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-16 rounded-2xl transition-all shadow-lg hover:shadow-blue-200 disabled:opacity-50" disabled>
                    Bắt đầu luyện tập
                </button>
            </div>
        </div>

        <!-- MÀN HÌNH LÀM BÀI (Giữ nguyên logic cũ) -->
        <div id="quiz-screen" class="hidden">
            <div class="flex flex-wrap justify-between items-end mb-6 gap-4">
                <div>
                    <h2 id="current-topic-label" class="text-blue-600 font-bold text-sm uppercase tracking-widest mb-1">Đang làm bài</h2>
                    <div class="text-3xl font-black text-slate-900">Câu <span id="current-index-display">1</span><span class="text-slate-300 mx-1">/</span><span id="total-count-display">0</span></div>
                </div>
                <div class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-200">
                    <span class="text-xs text-slate-400 uppercase font-bold block">Thời gian còn lại</span>
                    <div id="timer-display" class="text-2xl font-mono font-bold text-red-500">00:00</div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div id="progress-bar" class="h-1.5 bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                <div class="p-8 md:p-12">
                    <h2 id="question-text" class="text-xl md:text-2xl font-semibold leading-snug mb-10">...</h2>
                    <div id="options-container" class="grid grid-cols-1 gap-4"></div>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <button id="prev-btn" onclick="quizApp.prevQuestion()" class="flex items-center gap-2 px-6 py-3 text-slate-500 font-bold hover:text-blue-600 transition-colors disabled:opacity-20">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg> Quay lại
                </button>
                <div class="flex gap-4">
                    <button id="next-btn" onclick="quizApp.nextQuestion()" class="bg-slate-900 hover:bg-black text-white px-10 py-4 rounded-2xl font-bold transition-all shadow-lg">Tiếp theo</button>
                    <button id="submit-btn" onclick="quizApp.confirmSubmit()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-2xl font-bold transition-all shadow-lg">Nộp bài</button>
                </div>
            </div>
        </div>

        <!-- MÀN HÌNH KẾT QUẢ -->
        <div id="result-screen" class="hidden space-y-8">
            <div class="bg-white rounded-3xl shadow-sm p-10 border border-slate-200 text-center">
                <h2 class="text-3xl font-black mb-2">Kết quả bài làm</h2>
                <div id="score-text" class="text-5xl font-black text-blue-600 my-6">0%</div>
                <p class="text-slate-500 mb-8">Bạn đúng <span id="correct-count-text">0</span>/<span id="total-count-text">0</span> câu.</p>
                <button onclick="location.reload()" class="bg-slate-900 text-white font-bold py-4 px-12 rounded-2xl transition-all">Làm lại</button>
            </div>
            <div id="review-container" class="space-y-4"></div>
        </div>
    </div>

    <script>
        class QuizApp {
            constructor() {
                this.questionBank = {};
                this.selectedTopicKey = 'all';
                this.questions = [];
                this.currentIndex = 0;
                this.userAnswers = [];
                this.timer = null;
                this.timeLeft = 0;
            }

            // Hàm nạp dữ liệu (ae để ý CORS, đưa file json lên cloud rồi sử dụng)
            async loadData() {
                try {
                    const response = await fetch('https://api.npoint.io/9ce443046853afc1110b'); 
                    if (!response.ok) throw new Error("CORS or 404");
                    
                    const data = await response.json();
                    this.finalizeDataLoad(data);
                } catch (error) {
                    console.warn("Không thể fetch tự động, chuyển sang chế độ chọn file thủ công.");
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('loading-text').innerText = "Vui lòng chọn ngân hàng câu hỏi";
                    document.getElementById('manual-upload').classList.remove('hidden');
                }
            }

            // Xử lý file khi người dùng chọn thủ công (Cái này phải cải tiến auto-fix file đấy)
            handleManualFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.finalizeDataLoad(data);
                    } catch (err) {
                        alert("File JSON không đúng định dạng!");
                    }
                };
                reader.readAsText(file);
            }

            finalizeDataLoad(data) {
                this.questionBank = data;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('start-btn').disabled = false;
                this.initMenu();
            }

            initMenu() {
                const grid = document.getElementById('topic-grid');
                grid.innerHTML = `
                    <div class="topic-card bg-slate-50 p-5 rounded-2xl border-2 border-slate-100 topic-selected" id="topic-all" onclick="quizApp.selectTopic('all')">
                        <h4 class="font-bold text-slate-800">Tất cả chương</h4>
                        <p class="text-xs text-slate-400 mt-1">Luyện tập tổng hợp</p>
                    </div>
                `;

                let totalCount = 0;
                for (const key in this.questionBank) {
                    const topic = this.questionBank[key];
                    totalCount += topic.questions.length;
                    grid.innerHTML += `
                        <div class="topic-card bg-white p-5 rounded-2xl border-2 border-slate-100" id="topic-${key}" onclick="quizApp.selectTopic('${key}')">
                            <h4 class="font-bold text-slate-800 text-sm">${topic.title}</h4>
                            <p class="text-xs text-slate-400 mt-1">${topic.questions.length} câu hỏi</p>
                        </div>
                    `;
                }
                document.getElementById('stat-total-questions').innerText = totalCount + " câu";
            }

            selectTopic(key) {
                this.selectedTopicKey = key;
                document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('topic-selected'));
                document.getElementById(`topic-${key}`).classList.add('topic-selected');
                document.getElementById('stat-selected-topic').innerText = key === 'all' ? 'Tất cả' : this.questionBank[key].title;
            }

            startQuiz() {
                if (this.selectedTopicKey === 'all') {
                    this.questions = [];
                    for (const key in this.questionBank) {
                        this.questions = [...this.questions, ...this.questionBank[key].questions];
                    }
                } else {
                    this.questions = [...this.questionBank[this.selectedTopicKey].questions];
                }

                this.questions.sort(() => Math.random() - 0.5);
                this.userAnswers = new Array(this.questions.length).fill(null);
                this.currentIndex = 0;
                this.timeLeft = parseInt(document.getElementById('timer-select').value) * 60;

                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('total-count-display').innerText = this.questions.length;
                document.getElementById('current-topic-label').innerText = this.selectedTopicKey === 'all' ? 'Tổng hợp' : this.questionBank[this.selectedTopicKey].title;

                this.renderQuestion();
                this.startTimer();
            }

            renderQuestion() {
                const q = this.questions[this.currentIndex];
                document.getElementById('question-text').innerText = q.q;
                document.getElementById('current-index-display').innerText = this.currentIndex + 1;
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `option-card text-left p-5 rounded-2xl border-2 border-slate-100 flex items-start gap-4 ${this.userAnswers[this.currentIndex] === idx ? 'option-selected' : ''}`;
                    btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center font-bold text-slate-400 text-sm border">${String.fromCharCode(65+idx)}</span><span class="pt-1 font-medium">${opt}</span>`;
                    btn.onclick = () => { this.userAnswers[this.currentIndex] = idx; this.renderQuestion(); };
                    container.appendChild(btn);
                });

                document.getElementById('prev-btn').disabled = this.currentIndex === 0;
                const isLast = this.currentIndex === this.questions.length - 1;
                document.getElementById('next-btn').classList.toggle('hidden', isLast);
                document.getElementById('submit-btn').classList.toggle('hidden', !isLast);
                document.getElementById('progress-bar').style.width = `${((this.currentIndex + 1) / this.questions.length) * 100}%`;
            }

            nextQuestion() { if (this.currentIndex < this.questions.length - 1) { this.currentIndex++; this.renderQuestion(); } }
            prevQuestion() { if (this.currentIndex > 0) { this.currentIndex--; this.renderQuestion(); } }
            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    const m = Math.floor(this.timeLeft / 60); const s = this.timeLeft % 60;
                    document.getElementById('timer-display').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    if (this.timeLeft <= 0) this.submitQuiz();
                }, 1000);
            }
            confirmSubmit() { if (confirm("Nộp bài?")) this.submitQuiz(); }
            submitQuiz() {
                clearInterval(this.timer);
                document.getElementById('quiz-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                this.showResults();
            }
            showResults() {
                let correct = 0;
                const container = document.getElementById('review-container');
                container.innerHTML = '<h3 class="text-xl font-bold mb-4">Xem lại bài làm</h3>';
                this.questions.forEach((q, i) => {
                    const isCorrect = this.userAnswers[i] === q.correct;
                    if (isCorrect) correct++;
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-3xl border mb-4";
                    card.innerHTML = `<div class="font-bold mb-4">Câu ${i+1}: ${q.q}</div>
                    <div class="space-y-2 mb-4">${q.options.map((opt, idx) => `<div class="p-3 rounded-xl border text-sm ${idx === q.correct ? 'correct-answer' : (idx === this.userAnswers[i] ? 'wrong-answer' : 'border-slate-50')}">${opt}</div>`).join('')}</div>
                    ${q.explain ? `<div class="bg-blue-50 p-4 rounded-xl text-blue-700 text-sm"><strong>Giải thích:</strong> ${q.explain}</div>` : ''}`;
                    container.appendChild(card);
                });
                document.getElementById('correct-count-text').innerText = correct;
                document.getElementById('total-count-text').innerText = this.questions.length;
                document.getElementById('score-text').innerText = Math.round((correct / this.questions.length) * 100) + "%";
            }
        }

        const quizApp = new QuizApp();
        window.onload = () => quizApp.loadData();
    </script>
</body>
</html>